---
title: TCP-IP
date: 2018-08-14 17:54:51
tags: [网络]
categories: 基础知识
---

本文记录 TCP/IP 相关知识点。
<!-- more -->

# 计算机网络体系结构

{% asset_img 计算机网络体系结构.png 计算机网络体系结构 %}

# TCP/IP

它只有四层，相当于五层协议中的数据链路层和物理层合并为网络接口层。
TCP/IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。
{% asset_img TCP-IP体系结构.png %}

TCP/IP协议族是一种沙漏形状，中间小两边打，IP 协议在其中占用举足轻重的地位。
{% asset_img TCP-IP沙漏形状.png %}

# 传输层

## UDP 和 TCP 的特点

* 用户数据报协议 UDP (User Datagram Protocol) 是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一 和 多对多的交互通信。
* 传输控制协议 TCP (Transmission Control Protocol)是面向连接的，提供可靠交付，有流量控制、拥塞控制、提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是一对一的（点对点）。

## UDP首部格式

{% asset_img udp首部格式.jpg %}
首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

## TCP首部格式

{% asset_img tcp报文段首部格式.png %}

* 序号：用于对字节流进行编号，例如编号为301，表示第一个字节的编号为301，如果携带数据长度为100字节，那么下一个报文段的编号为401。
* 确认号：期望收到的下一个报文段的编号。例如，B 正确收到 A 发来的一个报文段，编号为501，携带数据长度为200字节，那么 B 期望收到的下一个报文段的编号为701. B发送给 A 的确认报文段中的确认号就为701.
* 数据偏移：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。
* 确认 ACK：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
* 同步 SYN：在连接建立时用来同步序号。当 SYN=1，ACK=0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN=1，ACK=1。
* 终止 FIN ：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
* 窗口：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

## TCP 的三次握手

{% asset_img 三次握手.png %}

以客户端 A 与服务器 B 用三次握手建立 TCP 连接为例：

* 首先服务器 B 处于 LISTEN(监听)状态，等待客户端的连接请求。
* 客户端 A 向服务器 B发送连接请求报文，SYN=1,ACK=0,选择一个初始的序号x.
* 服务器 B 收到连接请求报文，如果同意建立连接，则向客户端 A 发送连接确认报文，SYN=1,ACK=1,确认号为x+1,初始的序号为y.
* 客户端 A 收到服务器 B 的连接确认报文后，还要向服务器 B 发送确认，确认号为y+1,序号为 x+1。
* 服务器 B 收到客户端 A 的确认后，连接建立。

### **三次握手的原因**

第三次握手是为了防止失效的连接请求到达服务器，让服务器打开连接。

客户端发送的连接请求可能会在网络中滞留，客户端等待一个超时重传时间之后，就会重新发送连接请求。但是这个滞留的连接请求可能最后还是会到达服务器，如果不进行第三次握手，那么服务器就会打开连个连接。如果有第三次握手，客户端就会忽略服务器之后发送的对滞留连接请求的连接确认，不进行第三次握手，因此就不会再次打开连接。

## TCP 的四次挥手

{% asset_img 四次挥手.jpg %}

* 客户端 A 发送连接释放报文，FIN=1.
* 服务器 B 收到之后发送确认，此时 TCP 处于半关闭状态，服务器B 能向客户端 A 发送数据，但是客户端 A 不能向服务器 B 发送数据。
* 当服务器 B 不再需要连接时，发送连接释放报文，FIN=1.
* 客户端 A 收到之后发送确认，进入 TIME_WAIT 状态，等待2 MSL(最大报文存活时间)后释放连接。
* 服务器 B 收到客户端 A的确认后释放连接。

### 四次挥手的原因

客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进人了 CLOSE-WAIT 状态。这个状态是为了让服务器发送还未传送完的数据，传送完毕之后，服务器就会发送 FIN 连接释放报文。

### TIME_WAIT

客户端收到服务器的FIN连接释放报文，发送确认后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间，2MSL。这样做的原因：

* 确保最后一个确认报文能够到达服务器。如果服务器B 没有收到客户端 A发送来的确认报文，那么就会重新发送连接释放请求报文，客户端 A 等待一段时间就是为了处理这种情况的发生。
* 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的链接不会出现旧的连接请求报文。